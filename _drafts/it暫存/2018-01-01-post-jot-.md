---
layout: post
title: '[Node.js打造API] 使用 joi 驗證POST資料'
categories: '2018iT邦鐵人賽'
description: 
keywords: api,post,joi
---

## 本文你將會學到
- 了解 joi 是什麼
- 使用 joi 來驗證POST資料

## 前言
相信個都都有使用過 Facebook 還記得註冊時是否要求你輸入姓名、信箱與密碼，當你輸入的資訊不符合資料規範時就會挑出警示且叫你修正，如下圖這種作法相信在各大網站都會做出類似的驗證來確保你的資料是否遵循規則而不是亂填，那至於圖片所提到的情況是利用前端的方式用正規表示法(Regular Expression )來做驗證或是 HTML 的 [input pattern](https://www.w3schools.com/tags/att_input_pattern.asp) 來完成驗證資料，這邊拋出一個問題，想想看那今天有人使用特別方法破解前端把資料硬塞進去豈不是就功虧一簣了！所以後端這邊還是必須保守最後一道防線，當前端傳送資料進來時使用 `joi` 來做資料正規化的驗證。

<img src="/images/posts/it2018/img1070107-1.png">

## 什麼是 joi?
相信各位一定不陌生先前有出現過，是使用在環境變數的驗證，這邊再拿出來複習一下，joi 是一個資料檢查的機制，你可以自己規範 schema 來限制資料格式。

### 使用 joi 來驗證POST資料

##### 1.安裝 joi

若還沒安裝在 Package 的讀者可以先安裝 joi 至 dependencies。

```bash
yarn add joi
```

##### 2.安裝 express-validation

`express-validation` 是 express.js 的其中一個 middleware ，搭配 joi 使用可以再進入路由前先跑去 middleware 做 joi 的驗證若資料無誤就能進去主路由繼續完成工作。

```bash
yarn add express-validation
```

##### 3. 建立 param-validation.js

請將 `param-validation.js` 建立 在 `src<config` 資料夾底下，在這個檔案裡面我們就來分別寫 `User` 和 `Article` 的 joi 規則。

```js
// param-validation.js
import Joi from 'joi';

export default {
  // POST /api/article
  createArticle: {
    body: {
      user_id: Joi.number().required(), // 數字＋必填
      article_title: Joi.string().required(), // 字串＋必填
      article_tag: Joi.string().required(), // 字串＋必填
      article_content: Joi.string().min(20).required() // 文章長度至少20字
    }
  },
  // POST /api/user
  createUser: {
    body: {
      user_name: Joi.string().required(), // 字串＋必填
      user_mail: Joi.string().email().trim().required(), // 限定email格式並移除多餘空白
      user_password: Joi.string().regex(/[a-zA-Z0-9]{6,30}$/).required() // 最小長度6最大30，只允許英文大小寫和數字
    }
  }
};
```
